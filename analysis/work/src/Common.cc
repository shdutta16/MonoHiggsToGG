#include "../interface/Common.hh"
#include "../interface/CommonTypes.hh"

#include "TSystem.h"
#include "TLatex.h"

void next_arg_or_die(lStr_t& args, lStr_i& i, bool allow_single_minus) {
  lStr_i j = i;
  if (++j == args.end() ||
      ((*j)[0] == '-' && ! (*j == "-" && allow_single_minus))) {
    std::cerr << "Error: option " << *i << " requires an argument ...exiting..." << std::endl;
    exit(1);
  }
  i = j;
}

void ComputeRatioPlot(const TH1F * numer, const TH1F * denom, TH1F *& ratioPlot){
  Double_t value = 0;
  Double_t err   = 0;
  for (Int_t bin = 1; bin <= ratioPlot->GetNbinsX(); bin++){
    if (denom->GetBinContent(bin)!=0){
      value = numer->GetBinContent(bin) / denom->GetBinContent(bin); 
      // Binonimal errors 
      err = sqrt( value*(1.0-value)/denom->GetBinContent(bin) );
      //Fill plots with correct values
      ratioPlot->SetBinContent(bin,value);
      ratioPlot->SetBinError(bin,err);
    }
  }
}

void MakeOutDir(TString outdir){
  FileStat_t dummyFileStat;
  if (gSystem->GetPathInfo(outdir.Data(), dummyFileStat) == 1){
    TString mkDir = "mkdir -p ";
    mkDir += outdir.Data();
    gSystem->Exec(mkDir.Data());
  }
}

void MakeSubDirs(TStrMap & subdirmap, TString outdir){
  for (TStrMapIter mapiter = subdirmap.begin(); mapiter != subdirmap.end(); mapiter++) { 
    TString path = outdir+"/";
    path.Append((*mapiter).second);
    MakeOutDir(Form("%s/",path.Data()));
    MakeOutDir(Form("%s/lin/",path.Data()));
    MakeOutDir(Form("%s/log/",path.Data()));
  }
}

void MoveInput(TString infile, TString outdir){
  TString mvin = "mv ";
  mvin += infile.Data();
  mvin += " ";
  mvin += outdir.Data();
  gSystem->Exec(mvin.Data());
}

void CheckValidFile(TFile *& file, TString fname){
  if (file == (TFile*) NULL) { // check if valid file
    std::cerr << "Input file is bad pointer: " << fname.Data()
	      << " ...exiting..." << std::endl;
    exit(1);
  }
  else {
    std::cout << "Successfully opened file: " << fname.Data() << std::endl;
  }
}

void CheckValidTree(TTree *& tree, TString tname, TString fname){
  if (tree == (TTree*) NULL) { // check if valid plot
    std::cerr << "Input TTree is bad pointer: " << tname.Data() << " in input file: " << fname.Data()
	      << " ...exiting..." << std::endl;
    exit(1);
  }
  else {
    std::cout << "Successfully opened tree: " << tname.Data() << " in input file: " << fname.Data() << std::endl;
  }
}

void CheckValidTH1F(TH1F *& plot, TString pname, TString fname){
  if (plot == (TH1F*) NULL) { // check if valid plot
    std::cerr << "Input TH1F is bad pointer: " << pname.Data() << " in input file: " << fname.Data() 
	      << " ...exiting..." << std::endl;
    exit(1);
  }
}

void CheckValidTH1D(TH1D *& plot, TString pname, TString fname){
  if (plot == (TH1D*) NULL) { // check if valid plot
    std::cerr << "Input TH1D is bad pointer: " << pname.Data() << " in input file: " << fname.Data() 
	      << " ...exiting..." << std::endl;
    exit(1);
  }
}

double GetIntegralAndError(TH1F* & plot, float xlow, float xhigh, double & err){
  int binlo = plot->FindBin(xlow);
  int binhi = plot->FindBin(xhigh);
  double integral = 0;
  integral = plot->IntegralAndError(binlo,binhi,err,"");
  return integral;
}

void CMSLumi(TCanvas *& canv){

  TString  latexCMS	= "CMS";
  TString  extraText	= "Preliminary";
  Bool_t   doExtraText	= (Config::extraText.EqualTo("",TString::kExact)?false:true);
  TString  latexHgg	= "Z' #rightarrow DM + h(#gamma#gamma)";
  TString  latexLumi	= Form("%1.1f fb^{-1} (13 TeV)",Config::lumi);

  TLatex *l1 = new TLatex(0.17,0.92,latexCMS);
  l1->SetTextSize(0.036);
  l1->SetTextAlign(12);
  l1->SetNDC(kTRUE);
  l1->SetTextFont(62);

  TLatex *l2 = new TLatex(0.25,0.92,extraText);
  if (doExtraText){
    l2->SetTextSize(0.036);
    l2->SetTextAlign(12);
    l2->SetNDC(kTRUE);
    l2->SetTextFont(52);
  } 

  TLatex *l3 = new TLatex(0.17,0.88,latexHgg);
  l3->SetTextSize(0.036);
  l3->SetTextAlign(12);
  l3->SetNDC(kTRUE);
  l3->SetTextFont(42);

  TLatex *l4 = new TLatex(0.715,0.98,latexLumi); 
  l4->SetTextSize(0.034);
  l4->SetTextAlign(12);
  l4->SetNDC(kTRUE);
  l4->SetTextFont(42);

  l1->Draw("same");
  if (doExtraText) l2->Draw("same");
  l3->Draw("same");
  l4->Draw("same");
}


//void CMSLumi(TCanvas *& canv, Int_t iPosX) {
//  TString  cmsText     = "CMS";
//  Double_t cmsTextFont = 61;  // default is helvetic-bold
//  
//  // extraText is either "Simulation" or "Preliminary"
//  Bool_t   writeExtraText  = (Config::extraText.EqualTo("",TString::kExact)?false:true);
//  Double_t extraTextFont   = 52;  // default is helvetica-italics
//
//  TString lumiText = Form("%5.1f fb^{-1} (13 TeV)", Config::lumi);
//  
//  // text sizes and text offsets with respect to the top frame
//  // in unit of the top margin size
//  Double_t lumiTextSize     = 0.6;
//  Double_t lumiTextOffset   = 0.2;
//  Double_t cmsTextSize      = 0.75;
//  Double_t cmsTextOffset    = 0.1;  // only used in outOfFrame version
//
//  Double_t relPosX    = 0.045;
//  Double_t relPosY    = 0.035;
//  Double_t relExtraDY = 1.2;
// 
//  // ratio of "CMS" and extra text size
//  Double_t extraOverCmsTextSize  = 0.76;
// 
//  Bool_t outOfFrame    = false;
//  if ( iPosX/10 == 0 ) {
//    outOfFrame = true;
//  }
//
//  Int_t alignY_=3;
//  Int_t alignX_=2;
//  if (iPosX/10 == 0) {alignX_ = 1;}
//  if (iPosX == 0)    {alignY_ = 1;}
//  if (iPosX/10 == 1) {alignX_ = 1;}
//  if (iPosX/10 == 2) {alignX_ = 2;}
//  if (iPosX/10 == 3) {alignX_ = 3;}
//  Int_t align_ = 10*alignX_ + alignY_;
//
//  Double_t H = canv->GetWh();
//  Double_t W = canv->GetWw();
//  Double_t l = canv->GetLeftMargin();
//  Double_t t = canv->GetTopMargin();
//  Double_t r = canv->GetRightMargin();
//  Double_t b = canv->GetBottomMargin();
//  Double_t e = 0.025;
//
//  TLatex latex;
//  latex.SetNDC();
//  latex.SetTextAngle(0);
//  latex.SetTextColor(kBlack);    
//
//  Double_t extraTextSize = extraOverCmsTextSize*cmsTextSize;
//
//  latex.SetTextFont(42);
//  latex.SetTextAlign(31); 
//  latex.SetTextSize(lumiTextSize*t);    
//  latex.DrawLatex(1-r,1-t+lumiTextOffset*t,lumiText);
//
//  if (outOfFrame) {
//    latex.SetTextFont(cmsTextFont);
//    latex.SetTextAlign(11); 
//    latex.SetTextSize(cmsTextSize*t);    
//    latex.DrawLatex(l,1-t+lumiTextOffset*t,cmsText);
//  }
//  
//  Double_t posX_;
//  if (iPosX%10 <= 1) {
//    posX_ =   l + relPosX*(1-l-r);
//  }
//  else if (iPosX%10 == 2) {
//    posX_ =  l + 0.5*(1-l-r);
//  }
//  else if (iPosX%10 == 3) {
//    posX_ =  1-r - relPosX*(1-l-r);
//  }
//
//  Double_t posY_ = 1-t - relPosY*(1-t-b);
//
//  if (!outOfFrame) {
//    latex.SetTextFont(cmsTextFont);
//    latex.SetTextSize(cmsTextSize*t);
//    latex.SetTextAlign(align_);
//    latex.DrawLatex(posX_, posY_, cmsText);
//    
//    if (writeExtraText) {
//      latex.SetTextFont(extraTextFont);
//      latex.SetTextAlign(align_);
//      latex.SetTextSize(extraTextSize*t);
//      latex.DrawLatex(posX_, posY_- relExtraDY*cmsTextSize*t, Config::extraText);
//    }
//  }
//  
//  else if (outOfFrame && writeExtraText){
//    if (iPosX == 0) {
//      posX_ = l +  relPosX*(1-l-r)+0.05;
//      posY_ = 1-t+lumiTextOffset*t;
//    }
//    latex.SetTextFont(extraTextFont);
//    latex.SetTextSize(extraTextSize*t);
//    latex.SetTextAlign(align_);
//    latex.DrawLatex(posX_, posY_, Config::extraText);      
//  }
//}

void SetTDRStyle(TStyle *& tdrStyle){  
  // For the canvas:
  tdrStyle->SetCanvasBorderMode(0);
  tdrStyle->SetCanvasColor(kWhite);
  //tdrStyle->SetCanvasDefH(600); //Height of canvas
  //tdrStyle->SetCanvasDefW(700); //Width of canvas
  tdrStyle->SetCanvasDefX(0);   //Position on screen
  tdrStyle->SetCanvasDefY(0);

  // For the Pad:
  tdrStyle->SetPadBorderMode(0);
  // tdrStyle->SetPadBorderSize(Width_t size = 1);
  tdrStyle->SetPadColor(kWhite);
  tdrStyle->SetPadGridX(false);
  tdrStyle->SetPadGridY(false);
  tdrStyle->SetGridColor(0);
  tdrStyle->SetGridStyle(3);
  tdrStyle->SetGridWidth(1);

  // For the frame:
  tdrStyle->SetFrameBorderMode(0);
  tdrStyle->SetFrameBorderSize(1);
  tdrStyle->SetFrameFillColor(0);
  tdrStyle->SetFrameFillStyle(0);
  tdrStyle->SetFrameLineColor(1);
  tdrStyle->SetFrameLineStyle(1);
  tdrStyle->SetFrameLineWidth(1);

  // For the histo:
  tdrStyle->SetHistLineColor(1);
  tdrStyle->SetHistLineStyle(0);
  tdrStyle->SetHistLineWidth(1);
  tdrStyle->SetEndErrorSize(2);
  tdrStyle->SetErrorX(0.5);
  tdrStyle->SetMarkerStyle(20);
  tdrStyle->SetMarkerSize(0.6);

  //For the fit/function:
  tdrStyle->SetOptFit(1);
  tdrStyle->SetFitFormat("5.4g");
  tdrStyle->SetFuncColor(2);
  tdrStyle->SetFuncStyle(1);
  tdrStyle->SetFuncWidth(1);

  //For the date:
  tdrStyle->SetOptDate(0);
  // tdrStyle->SetDateX(Float_t x = 0.01);
  // tdrStyle->SetDateY(Float_t y = 0.01);

  // For the statistics box:
  tdrStyle->SetOptFile(0);
  tdrStyle->SetOptStat(0); // To display the mean and RMS:   SetOptStat("mr");
  tdrStyle->SetStatColor(kWhite);
  tdrStyle->SetStatFont(42);
  tdrStyle->SetStatFontSize(0.025);
  tdrStyle->SetStatTextColor(1);
  tdrStyle->SetStatFormat("6.4g");
  tdrStyle->SetStatBorderSize(1);
  tdrStyle->SetStatH(0.1);
  tdrStyle->SetStatW(0.15);
  
  // Margins:
  tdrStyle->SetPadTopMargin(0.05);
  tdrStyle->SetPadBottomMargin(0.14);
  tdrStyle->SetPadLeftMargin(0.18);
  tdrStyle->SetPadRightMargin(0.15); 

  // For the Global title:

  tdrStyle->SetOptTitle(0);
  tdrStyle->SetTitleFont(42);
  tdrStyle->SetTitleColor(1);
  tdrStyle->SetTitleTextColor(1);
  tdrStyle->SetTitleFillColor(10);
  tdrStyle->SetTitleFontSize(0.05);
  // tdrStyle->SetTitleH(0); // Set the height of the title box
  // tdrStyle->SetTitleW(0); // Set the width of the title box
  // tdrStyle->SetTitleX(0); // Set the position of the title box
  // tdrStyle->SetTitleY(0.985); // Set the position of the title box
  // tdrStyle->SetTitleStyle(Style_t style = 1001);
  // tdrStyle->SetTitleBorderSize(2);

  // For the axis titles:

  tdrStyle->SetTitleColor(1, "XYZ");
  tdrStyle->SetTitleFont(42, "XYZ");
  tdrStyle->SetTitleSize(Config::TitleSize, "XYZ");
  tdrStyle->SetTitleXOffset(Config::TitleXOffset);
  tdrStyle->SetTitleYOffset(Config::TitleYOffset);

  // For the axis labels:

  tdrStyle->SetLabelColor(1, "XYZ");
  tdrStyle->SetLabelFont(42, "XYZ");
  tdrStyle->SetLabelOffset(Config::LabelOffset, "XYZ");
  tdrStyle->SetLabelSize(Config::LabelSize, "XYZ");

  // For the axis:

  tdrStyle->SetAxisColor(1, "XYZ");
  tdrStyle->SetStripDecimals(kTRUE);
  tdrStyle->SetTickLength(Config::TickLength, "XYZ");
  //  tdrStyle->SetNdivisions(510, "XYZ");
  tdrStyle->SetNdivisions(505, "X");
  tdrStyle->SetPadTickX(1);  // To get tick marks on the opposite side of the frame
  tdrStyle->SetPadTickY(1);

  // Change for log plots:
  tdrStyle->SetOptLogx(0);
  tdrStyle->SetOptLogy(0);
  tdrStyle->SetOptLogz(0);

  // Postscript options:
  // tdrStyle->SetPaperSize(15.,15.);
  // tdrStyle->SetLineScalePS(Float_t scale = 3);
  // tdrStyle->SetLineStyleString(Int_t i, const char* text);
  // tdrStyle->SetHeaderPS(const char* header);
  // tdrStyle->SetTitlePS(const char* pstitle);

  // tdrStyle->SetBarOffset(Float_t baroff = 0.5);
  // tdrStyle->SetBarWidth(Float_t barwidth = 0.5);
  // tdrStyle->SetPaintTextFormat(const char* format = "g");
  // tdrStyle->SetPalette(Int_t ncolors = 0, Int_t* colors = 0);
  // tdrStyle->SetTimeOffset(Double_t toffset);
  // tdrStyle->SetHistMinimumZero(kTRUE);
  
  // for a nice color palette
  const Int_t NRGBs = 5;
  const Int_t NCont = 255;
  
  Double_t stops[NRGBs] = { 0.00, 0.34, 0.61, 0.84, 1.00 };
  Double_t red[NRGBs]   = { 0.00, 0.00, 0.87, 1.00, 0.51 };
  Double_t green[NRGBs] = { 0.00, 0.81, 1.00, 0.20, 0.00 };
  Double_t blue[NRGBs]  = { 0.51, 1.00, 0.12, 0.00, 0.00 };
  TColor::CreateGradientColorTable(NRGBs, stops, red, green, blue, NCont);
  tdrStyle->SetNumberContours(NCont);

  tdrStyle->cd();
}

